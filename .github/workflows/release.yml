name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  release:
    name: Build and release if version is newer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Extract version from build.gradle
        id: version
        run: |
          VERSION=$(grep "^version\s*=" build.gradle | head -n1 | sed -E "s/.*'(.*)'.*/\1/")
          if [ -z "$VERSION" ]; then
            echo "Version not found in build.gradle" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Check if tag already exists
        id: tag_check
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ steps.version.outputs.version }}$"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "⚠️  Tag v${{ steps.version.outputs.version }} already exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "✓ Tag v${{ steps.version.outputs.version }} does not exist"
          fi

      - name: Check latest GitHub release version
        id: compare
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
          TAG_EXISTS: ${{ steps.tag_check.outputs.exists }}
        run: |
          LATEST=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" | jq -r '.tag_name // ""')
          export LATEST

          python3 - <<'PY'
          import os, re

          version = os.environ["VERSION"]
          latest = os.environ.get("LATEST", "")
          tag_exists = os.environ.get("TAG_EXISTS", "false") == "true"

          def normalize(v: str):
              v = v.lstrip("vV")
              parts = re.findall(r"\d+", v)
              return [int(p) for p in parts] if parts else []

          cv = normalize(version)
          lv = normalize(latest) if latest else []
          
          # Don't release if tag already exists or version is not newer
          should_release = not tag_exists and (not lv or cv > lv)
          
          print(f"Current version: {version} (normalized: {cv})")
          print(f"Latest release: {latest or 'none'} (normalized: {lv})")
          print(f"Tag exists: {tag_exists}")
          print(f"Should release: {should_release}")
          
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"latest={latest}\n")
              f.write(f"should_release={str(should_release).lower()}\n")
          PY

      - name: Stop if version is not newer or tag exists
        if: steps.compare.outputs.should_release != 'true'
        run: |
          if [ "${{ steps.tag_check.outputs.exists }}" = "true" ]; then
            echo "✗ Tag v${{ steps.version.outputs.version }} already exists. Skipping release."
          else
            echo "✗ Current version (${{ steps.version.outputs.version }}) is not newer than latest release (${{ steps.compare.outputs.latest }}). Skipping release."
          fi
          exit 0

      - name: Build with Gradle
        if: steps.compare.outputs.should_release == 'true'
        run: |
          chmod +x ./gradlew
          ./gradlew clean shadowJar --stacktrace

      - name: Verify build artifacts
        if: steps.compare.outputs.should_release == 'true'
        id: verify
        run: |
          echo "Checking build output..."
          ls -la build/libs/
          
          # Find the actual JAR file
          JAR_FILE=$(find build/libs/ -name "*.jar" -type f ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n1)
          if [ -z "$JAR_FILE" ]; then
            echo "❌ No JAR file found in build/libs/" >&2
            exit 1
          fi
          
          # Verify file size (should be > 1KB)
          FILE_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE" 2>/dev/null)
          if [ "$FILE_SIZE" -lt 1024 ]; then
            echo "❌ JAR file is suspiciously small ($FILE_SIZE bytes)" >&2
            exit 1
          fi
          
          echo "jar_path=$JAR_FILE" >> "$GITHUB_OUTPUT"
          echo "✓ Found JAR: $JAR_FILE ($(numfmt --to=iec-i --suffix=B $FILE_SIZE 2>/dev/null || echo ${FILE_SIZE}B))"

      - name: Generate changelog
        if: steps.compare.outputs.should_release == 'true'
        id: changelog
        run: |
          if [ -n "${{ steps.compare.outputs.latest }}" ]; then
            # Generate changelog from commits since last release
            CHANGELOG=$(git log ${{ steps.compare.outputs.latest }}..HEAD --pretty=format:"- %s" --no-merges)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="- Initial release"
            fi
          else
            CHANGELOG="- Initial release"
          fi
          
          # Escape for GitHub Actions
          echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGELOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        if: steps.compare.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: BellaAddon v${{ steps.version.outputs.version }}
          body: |
            ## Changes
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## Installation
            
            Download the JAR file below and place it in your plugins folder.
          draft: false
          prerelease: false
          files: ${{ steps.verify.outputs.jar_path }}
          fail_on_unmatched_files: true
          generate_release_notes: true