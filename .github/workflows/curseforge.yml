name: CurseForge Release

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

permissions:
  contents: read

jobs:
  curseforge:
    name: Publish to CurseForge if version is newer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Extract version from build.gradle
        id: version
        run: |
          VERSION=$(grep "^version\s*=" build.gradle | head -n1 | sed -E "s/.*'(.*)'.*/\1/")
          if [ -z "$VERSION" ]; then
            echo "Version not found in build.gradle" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Check latest CurseForge version
        id: compare
        env:
          CF_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
          CF_PROJECT_ID: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [ -z "$CF_API_KEY" ] || [ -z "$CF_PROJECT_ID" ]; then
            echo "CurseForge secrets are not set" >&2
            exit 1
          fi

          RESPONSE=$(curl -s -H "Accept: application/json" -H "x-api-key: $CF_API_KEY" \
            "https://api.curseforge.com/v1/mods/${CF_PROJECT_ID}/files?pageSize=1&sortDescending=true")

          LATEST_NAME=$(echo "$RESPONSE" | jq -r '.data[0].fileName // ""')
          export LATEST_NAME

          python3 - <<'PY'
          import os, re, sys

          def normalize(v: str):
              v = v.lstrip("vV")
              parts = re.findall(r"\d+", v)
              return [int(p) for p in parts] if parts else []

          version = os.environ["VERSION"]
          latest_name = os.environ.get("LATEST_NAME", "")

          latest_version = ""
          if latest_name:
              match = re.search(r"([0-9]+(?:\.[0-9]+)+)", latest_name)
              if match:
                  latest_version = match.group(1)

          cv = normalize(version)
          lv = normalize(latest_version)
          should_publish = not lv or cv > lv

          print(f"Current version: {version} (normalized: {cv})")
          print(f"Latest CurseForge file: {latest_name or 'none'}")
          print(f"Latest version parsed: {latest_version or 'none'} (normalized: {lv})")
          print(f"Should publish: {should_publish}")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"latest_name={latest_name}\n")
              f.write(f"latest_version={latest_version}\n")
              f.write(f"should_publish={str(should_publish).lower()}\n")
          PY

      - name: Stop if version is not newer
        if: steps.compare.outputs.should_publish != 'true'
        run: |
          echo "✗ Current version (${{ steps.version.outputs.version }}) is not newer than CurseForge latest (${{ steps.compare.outputs.latest_version }}). Skipping publish."
          exit 0

      - name: Build with Gradle
        if: steps.compare.outputs.should_publish == 'true'
        run: |
          chmod +x ./gradlew
          ./gradlew clean shadowJar --stacktrace

      - name: Verify build artifacts
        if: steps.compare.outputs.should_publish == 'true'
        run: |
          echo "Checking build output..."
          ls -la build/libs/
          
          # Find the actual JAR file (handles different naming patterns)
          JAR_FILE=$(find build/libs/ -name "*.jar" -type f | head -n1)
          if [ -z "$JAR_FILE" ]; then
            echo "❌ No JAR file found in build/libs/" >&2
            exit 1
          fi
          echo "jar_path=$JAR_FILE" >> "$GITHUB_OUTPUT"
          echo "✓ Found JAR: $JAR_FILE"
        id: verify

      - name: Upload to CurseForge
        if: steps.compare.outputs.should_publish == 'true'
        uses: Kir-Antipov/mc-publish@v3
        with:
          curseforge-id: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_API_KEY }}
          files: ${{ steps.verify.outputs.jar_path }}
          name: BellaAddon ${{ steps.version.outputs.version }}
          version: ${{ steps.version.outputs.version }}
          changelog: "See GitHub release notes for version ${{ steps.version.outputs.version }}."
          loaders: |
            bukkit
            spigot
          game-versions: 1.20.1
          release-type: release